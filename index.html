<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ™ºèƒ½å•è¯é—ªå¡ç³»ç»Ÿ</title>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MMDS83C307"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-MMDS83C307');
  </script>

  <style>
    :root {
      --primary-color: #2196F3;
      --success-color: #4CAF50;
      --error-color: #f44336;
    }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      margin: 0;
      padding: 15px;
      box-sizing: border-box;
      position: relative;
    }

    .stats {
      position: fixed;
      left: 15px;
      top: 15px;
      background: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      font-size: 16px;
      z-index: 100;
      min-width: 120px;
      text-align: center;
    }

    .flashcard-wrapper {
      width: 100%;
      height: 50vh;
      min-height: 300px;
      margin: 70px 0 30px;
      flex-shrink: 0;
    }

    .flashcard-container {
      perspective: 1000px;
      width: 100%;
      height: 100%;
      position: relative;
    }

    .flashcard {
      width: 100%;
      height: 100%;
      position: absolute;
      transform-style: preserve-3d;
      transition: transform 0.4s;
      touch-action: manipulation;
    }

    .flashcard.flipped {
      transform: rotateY(180deg);
    }

    .card-face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      box-sizing: border-box;
      overflow: auto;
    }

    .front {
      font-size: 2.4rem;
      color: var(--primary-color);
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
    }

    .back {
      transform: rotateY(180deg);
      padding: 20px;
    }

    .translation {
      font-size: 2rem;
      color: var(--success-color);
      margin: 15px 0;
      text-align: center;
      line-height: 1.3;
    }

    .controls {
      display: flex;
      gap: 12px;
      margin: 20px 0;
      width: 100%;
      position: relative;
      z-index: 50;
    }

    button {
      padding: 16px 20px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 1.1rem;
      flex: 1;
      min-width: 44px;
      min-height: 44px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .master-btn {
      background: var(--success-color);
      color: white;
    }

    .next-btn {
      background: #FF9800;
      color: white;
    }

    .manage-panel {
      position: fixed;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
      width: 90%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .mastered-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: white;
      padding: 20px;
      overflow-y: auto;
      transform: translateX(100%);
      transition: transform 0.3s;
      z-index: 200;
    }

    .mastered-panel.active {
      transform: translateX(0);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 15px;
    }

    .panel-header h3 {
      margin: 0;
      flex: 1;
    }

    .close-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 8px 20px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .close-btn:hover {
      background: #1976D2;
      transform: translateY(-1px);
    }

    .mastered-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
      font-size: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.3s;
    }

    .mastered-item:hover {
      background: #f5f5f5;
    }

    .delete-btn {
      color: var(--error-color);
      font-size: 1.2rem;
      padding: 8px;
      margin-left: 10px;
    }

    .privacy-notice {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 500px;
      text-align: center;
      padding: 12px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      font-size: 0.8rem;
      color: #666;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      z-index: 90;
    }

    /* æ–°å¢åœ¨åŸæœ‰æ ·å¼æœ«å°¾ï¼Œåª’ä½“æŸ¥è¯¢å‰ */
    .speaker-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 5px;
      z-index: 10;
    }

    .speaker-btn:active {
      transform: scale(0.9);
    }

    /* ===== ç­›é€‰é¢æ¿æ ·å¼ ===== */
    .filter-panel {
      position: fixed;
      left: 15px;
      top: 70px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
      display: flex;
      gap: 12px;
      flex-direction: column;
      /* ğŸŸ¢ æ–°å¢ï¼šç«–æ’å¸ƒå±€ */
    }

    /* ğŸŸ¢ æ–°å¢ï¼šç«–æ’å†…éƒ¨å®¹å™¨ */
    .filter-column {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-group label {
      font-size: 0.95rem;
      color: #666;
    }

    .custom-select {
      position: relative;
      min-width: 120px;
    }

    .select-header {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f8f8;
    }

    .select-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 200;
      width: 100%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);

      /* ğŸŸ¢ æ–°å¢åŠ¨ç”»å±æ€§ */
      transition: opacity 0.2s, transform 0.2s;
      opacity: 0;
      transform: translateY(-10px);
      pointer-events: none;
    }

    /* ğŸŸ¢ æ–°å¢ï¼šä¸‹æ‹‰èœå•æ¿€æ´»çŠ¶æ€ */
    .select-options[style*="display: block"] {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .select-options div {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .select-options div:hover {
      background: #f5f5f5;
    }

    .select-all {
      color: var(--primary-color);
      font-weight: bold;
      border-bottom: 1px solid #eee;
    }

    .confirm-btn {
      background: var(--primary-color);
      color: white;
      padding: 8px 20px;
      border-radius: 20px;
      border: none;
      cursor: pointer;
      transition: opacity 0.2s;
      width: 100%;
      /* ğŸŸ¢ æ–°å¢ï¼šæŒ‰é’®å æ»¡å®½åº¦ */
    }

    .confirm-btn:active {
      opacity: 0.8;
    }

    .selected-info {
      position: fixed;
      left: 15px;
      top: 140px;
      background: white;
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      font-size: 0.9rem;
      color: #666;
      display: none;
      /* ğŸŸ¢ æ–°å¢ï¼šé»˜è®¤éšè— */
      flex-direction: column;
      /* ğŸŸ¢ æ–°å¢ï¼šç«–æ’å¸ƒå±€ */
      gap: 8px;
      /* ğŸŸ¢ æ–°å¢ï¼šå­é¡¹é—´è· */
    }

    /* ğŸ”µ ä¿®æ”¹ï¼šå­é¡¹ç«–æ’æ ·å¼ï¼ˆåŸä¸ºæ¨ªå‘æ’åˆ—ï¼‰ */
    .selected-info div {
      display: flex;
      flex-direction: column;
      /* ä¿®æ”¹ä¸ºç«–æ’ */
      gap: 5px;
    }

    /* ğŸŸ¢ æ–°å¢ï¼šé€‰é¡¹åˆ—è¡¨å®¹å™¨å’Œé¡¹æ ·å¼ */
    .selection-items {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-left: 15px;
    }

    .selected-item {
      padding: 4px 8px;
      background: #f5f5f5;
      border-radius: 4px;
      font-size: 0.85em;
    }

    @media (max-width: 768px) {
      .filter-panel {
        top: 60px;
        left: 10px;
        right: 10px;
        flex-direction: column;
      }

      .selected-info {
        display: none;
      }
    }

    #details {
      font-size: 1rem;
      color: #666;
      text-align: center;
      line-height: 1.4;
      margin-top: 15px;
      padding: 0 10px;
    }

    @media (min-width: 768px) {
      body {
        padding: 20px;
        max-width: 500px;
        margin: 0 auto;
      }

      .flashcard-wrapper {
        height: 280px;
        margin: 30px 0;
      }

      .front {
        font-size: 2.5rem;
      }

      .translation {
        font-size: 1.8rem;
      }

      .manage-panel {
        width: auto;
        left: auto;
        right: 20px;
        transform: none;
      }
    }

    @media (max-width: 480px) {
      .stats {
        padding: 12px 15px;
        font-size: 14px;
        left: 10px;
        top: 10px;
      }

      .flashcard-wrapper {
        height: 55vh;
        min-height: 250px;
        margin: 60px 0 25px;
      }

      .front {
        font-size: 2rem;
        padding: 15px;
      }

      .translation {
        font-size: 1.8rem;
      }

      .controls {
        flex-direction: row;
        margin: 15px 0;
        gap: 8px;
      }

      button {
        width: auto;
        padding: 12px 15px !important;
        font-size: 1rem !important;
      }

      .next-btn {
        position: relative;
        font-size: 0;
        /* éšè—åŸå§‹æ–‡å­— */
      }

      .next-btn::after {
        content: "ä¸‹ä¸€ä¸ª";
        font-size: 1rem !important;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        white-space: nowrap;
      }

      .privacy-notice {
        bottom: 90px;
        font-size: 0.75rem;
        padding: 10px;
      }

      .speaker-btn {
        font-size: 1.2rem;
        top: 10px;
        right: 10px;
      }
    }
  </style>
  <script>
    const embeddedWordData = {
      "ä¸€å¹´çº§ä¸Š": {
        "Module1": [
          {
            "word": "hello",
            "translation": "ä½ å¥½",
            "pos": "åè¯",
            "definition": "Hello! ä½ å¥½ï¼",
            "example": "Hello! ä½ å¥½ï¼"
          },
          {
            "word": "am",
            "translation": "æ˜¯ï¼ˆæˆ‘æ˜¯ï¼‰",
            "pos": "åè¯",
            "definition": "am",
            "example": "The American team won the championship."
          },
          {
            "word": "goodbye",
            "translation": "å†è§",
            "pos": "åè¯",
            "definition": "Goodbye is an action that means to send a message to someone you miss. It also implies leaving behind something or someone.",
            "example": "The teacher gave a goodbye at the end of the exam."
          }
        ]
      }
    };


    // ä¿®æ”¹å‡½æ•°å®šä¹‰ï¼Œæ˜¾å¼æ¥æ”¶äº‹ä»¶å¯¹è±¡

    // åœ¨å…¨å±€æ·»åŠ è¯­éŸ³åˆ—è¡¨å˜é‡
    let voices = [];

    function speakWord(event) {
      // 1. åŸºç¡€æ£€æŸ¥
      if (!currentWord) {
        console.error('speakWord: currentWord is undefined');
        return;
      }
      if (event) event.stopPropagation();

      console.log('speakWord: Attempting to speak:', currentWord.word);
      console.log('Browser:', navigator.userAgent);

      // 2. å¾®ä¿¡ç¯å¢ƒå¤„ç†
      const isWeChat = /MicroMessenger/i.test(navigator.userAgent);
      if (isWeChat) {
        console.log('WeChat environment: using audio fallback');
        const audio = new Audio(`audio/${currentWord.word}.wav`);
        audio.play().catch(err => {
          console.error('Audio play failed:', err);
          alert('å¾®ä¿¡å†…éœ€æ‰‹åŠ¨è§¦å‘ï¼šç‚¹å‡»åç¨ç­‰é‡è¯•');
        });
        return;
      }

      // 3. éå¾®ä¿¡ç¯å¢ƒä¸»é€»è¾‘
      console.log('Non-WeChat environment: using speechSynthesis');
      if (!('speechSynthesis' in window)) {
        const msg = "æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æœ—è¯»åŠŸèƒ½";
        console.error(msg);
        alert(msg);
        return;
      }

      // 4. è¯­éŸ³å¼•æ“å¤„ç†ï¼ˆæ ¸å¿ƒä¿®å¤éƒ¨åˆ†ï¼‰
      const speakWithVoice = (voice) => {
        // æ¸…é™¤é˜Ÿåˆ—é¿å…é˜»å¡
        speechSynthesis.cancel();

        const utterance = new SpeechSynthesisUtterance(currentWord.word);
        utterance.lang = 'en-US';
        utterance.voice = voice;

        // è°ƒè¯•äº‹ä»¶
        utterance.onstart = () => console.log('Speech STARTED');
        utterance.onend = () => console.log('Speech ENDED');
        utterance.onerror = (e) => {
          console.error('Speech ERROR:', e.name, e.message);
          alert(`è¯­éŸ³æ’­æ”¾å¤±è´¥: ${e.message}`);
        };
        utterance.onboundary = (e) => console.debug('Boundary:', e.charIndex, e.name);

        console.log('Speaking with voice:', voice ? voice.name : 'default');
        speechSynthesis.speak(utterance);

        // çŠ¶æ€æ£€æŸ¥
        setTimeout(() => {
          console.log('Speech state:', {
            pending: speechSynthesis.pending,
            speaking: speechSynthesis.speaking,
            paused: speechSynthesis.paused
          });
        }, 100);
      };

      // 5. è¯­éŸ³é€‰æ‹©é€»è¾‘
      const handleVoices = () => {
        const voices = speechSynthesis.getVoices();
        console.log('Available voices:', voices.map(v => `${v.name} (${v.lang})`));

        // ä¼˜å…ˆé€‰æ‹©Googleè‹±è¯­å¼•æ“
        const enVoice = voices.find(v =>
          v.lang.startsWith('en-') &&
          (v.name.includes('Google') || v.name.includes('English'))
        ) || voices.find(v => v.lang.startsWith('en-'));

        if (enVoice) {
          console.log('Selected voice:', enVoice.name);
          speakWithVoice(enVoice);
        } else if (voices.length > 0) {
          console.warn('No English voice, falling back to first available');
          speakWithVoice(voices[0]);
        } else {
          console.error('No voices available');
          alert('æœªæ‰¾åˆ°å¯ç”¨çš„è¯­éŸ³å¼•æ“');
        }
      };

      // 6. åˆå§‹åŒ–è¯­éŸ³å¼•æ“
      const initialVoices = speechSynthesis.getVoices();
      if (initialVoices.length > 0) {
        console.log('Voices pre-loaded');
        handleVoices();
      } else {
        console.log('Waiting for voices...');
        speechSynthesis.onvoiceschanged = () => {
          console.log('voiceschanged event fired');
          speechSynthesis.onvoiceschanged = null; // é˜²æ­¢é‡å¤è§¦å‘
          handleVoices();
        };

        // è¶…æ—¶å›é€€
        setTimeout(() => {
          if (speechSynthesis.pending) {
            console.warn('Voice load timeout, attempting anyway');
            handleVoices();
          }
        }, 2000);
      }
    }

  </script>

</head>

<body>
  <div class="stats">
    <span id="progress">è¿›åº¦ï¼š0/0</span>
  </div>

  <!-- åŸç­›é€‰é¢æ¿ä¿®æ”¹ä¸ºç«–æ’ç»“æ„ -->
  <div class="filter-panel" id="filterPanel">
    <div class="filter-column">
      <div class="filter-group">
        <label>æ•™æç‰ˆæœ¬ï¼š</label>
        <select class="filter-select" id="textbookSelect" disabled>
          <option>å¤–ç ”ç¤¾ä¸€èµ·ç‚¹</option>
        </select>
      </div>

      <div class="filter-group">
        <label>å¹´çº§ï¼š</label>
        <div class="custom-select">
          <div class="select-header" onclick="toggleDropdown('grade')">
            <span id="gradeLabel">å…¨é€‰</span>
            <span class="arrow">â–¼</span>
          </div>
          <div class="select-options" id="gradeOptions">
            <div class="select-all" onclick="selectAll('grade')">å…¨é€‰</div>
          </div>
        </div>
      </div>

      <div class="filter-group">
        <label>å•å…ƒï¼š</label>
        <div class="custom-select">
          <div class="select-header" onclick="toggleDropdown('module')">
            <span id="moduleLabel">å…¨é€‰</span>
            <span class="arrow">â–¼</span>
          </div>
          <div class="select-options" id="moduleOptions">
            <div class="select-all" onclick="selectAll('module')">å…¨é€‰</div>
          </div>
        </div>
      </div>

      <button class="confirm-btn" onclick="applyFilters()">ç¡®è®¤</button>
    </div>
  </div>

  <!-- ä¿®æ”¹é€‰ä¸­ä¿¡æ¯ä¸ºç«–æ’ -->
  <div class="selected-info" id="selectedInfo">
    <div>æ•™æç‰ˆæœ¬ï¼š<span>å¤–ç ”ç¤¾ä¸€èµ·ç‚¹</span></div>
    <div class="selection-group">
      <div>å¹´çº§ï¼š</div>
      <div id="selectedGradeList" class="selection-items"></div>
    </div>
    <div class="selection-group">
      <div>å•å…ƒï¼š</div>
      <div id="selectedModuleList" class="selection-items"></div>
    </div>
  </div>

  <div class="flashcard-wrapper">
    <div class="flashcard-container">
      <div class="flashcard">
        <div class="card-face front">
          <button class="speaker-btn" onclick="speakWord(event)">ğŸ”Š</button>
          <span id="current-word">Loading...</span>
        </div>
        <div class="card-face back">
          <div class="translation" id="translation"></div>
          <div id="details"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="controls">
    <button class="master-btn" onclick="markAsMastered()">å·²æŒæ¡</button>
    <button class="next-btn" onclick="nextWord()">ä¸‹ä¸€ä¸ª</button>
  </div>

  <div class="manage-panel">
    <button onclick="showMasteredWords()">ç®¡ç†å·²æŒæ¡å•è¯</button>
    <button onclick="clearAllProgress()" style="margin-top: 10px;">é‡ç½®å­¦ä¹ è¿›åº¦</button>
  </div>

  <div class="mastered-panel" id="masteredPanel">
    <div class="panel-header">
      <h3>å·²æŒæ¡å•è¯ï¼ˆç‚¹å‡»åˆ é™¤ï¼‰</h3>
      <button class="close-btn" onclick="closeMasteredPanel()">è¿”å›</button>
    </div>
    <div id="masteredList"></div>
  </div>

  <div class="privacy-notice">
    <small>
      ğŸ“Œ éšç§è¯´æ˜ï¼šæ‚¨çš„å­¦ä¹ è¿›åº¦æ•°æ®ï¼ˆå·²æŒæ¡å•è¯ï¼‰ä»…å­˜å‚¨åœ¨æœ¬åœ°è®¾å¤‡ä¸­ï¼Œä¸ä¼šä¸Šä¼ è‡³ä»»ä½•æœåŠ¡å™¨ã€‚
      æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å°†åˆ é™¤è¿™äº›æ•°æ®ï¼Œæ‚¨ä¹Ÿå¯ä»¥éšæ—¶ä½¿ç”¨æœ¬é¡µé¢çš„<a href="javascript:clearAllProgress()">é‡ç½®å­¦ä¹ è¿›åº¦</a>åŠŸèƒ½ã€‚
    </small>
  </div>

  <div class="privacy-notice" id="voiceHint" style="display: none;">
    <small>ğŸ”ˆ é¦–æ¬¡ä½¿ç”¨è¯·ç‚¹å‡»ä»»æ„å•è¯å¡æˆ–æŒ‰é’®ä»¥å¯ç”¨è¯­éŸ³åŠŸèƒ½</small>
  </div>

  <script>
    let selectedGrades = [];
    let selectedModules = [];
    const GRADE_LIST = ['ä¸€å¹´çº§ä¸Š', 'ä¸€å¹´çº§ä¸‹', 'äºŒå¹´çº§ä¸Š', 'äºŒå¹´çº§ä¸‹', 'ä¸‰å¹´çº§ä¸Š', 'ä¸‰å¹´çº§ä¸‹', 'å››å¹´çº§ä¸Š', 'å››å¹´çº§ä¸‹', 'äº”å¹´çº§ä¸Š', 'äº”å¹´çº§ä¸‹', 'å…­å¹´çº§ä¸Š', 'å…­å¹´çº§ä¸‹'];
    const MODULE_LIST = Array.from({ length: 10 }, (_, i) => `Module${i + 1}`);

    let allWords = [];
    let currentWord = null;
    let masteredWords = JSON.parse(localStorage.getItem('masteredWords') || '[]');

    // åˆå§‹åŒ–æ•°æ®
    function initFilters() {
      // åˆå§‹åŒ–å¹´çº§é€‰é¡¹
      const gradeOptions = document.getElementById('gradeOptions');
      GRADE_LIST.forEach(grade => {
        const div = document.createElement('div');
        div.textContent = grade;
        div.onclick = (e) => {
          e.stopPropagation();
          toggleSelect('grade', grade);
        };
        gradeOptions.appendChild(div);
      });

      // åˆå§‹åŒ–æ¨¡å—é€‰é¡¹
      const moduleOptions = document.getElementById('moduleOptions');
      MODULE_LIST.forEach(module => {
        const div = document.createElement('div');
        div.textContent = module;
        div.onclick = (e) => {
          e.stopPropagation();
          toggleSelect('module', module);
        };
        moduleOptions.appendChild(div);
      });

      // éé¦–æ¬¡è¿›å…¥åŠ è½½ä¿å­˜çš„ç­›é€‰çŠ¶æ€
      const savedGrades = localStorage.getItem('selectedGrades');
      const savedModules = localStorage.getItem('selectedModules');
      if (savedGrades) selectedGrades = JSON.parse(savedGrades);
      if (savedModules) selectedModules = JSON.parse(savedModules);
      updateSelectedLabels();
    }

    // åœ¨ initializeData å‡½æ•°ä¸­æ·»åŠ è¯­éŸ³å¼•æ“åŠ è½½ç›‘å¬
    function initializeData() {
      try {
        // ==== æ ¸å¿ƒæ•°æ®åˆå§‹åŒ– ====
        allWords = flattenData(embeddedWordData);
        if (allWords.length === 0) throw new Error("è¯åº“ä¸ºç©º");

        // ==== ç­›é€‰å™¨åˆå§‹åŒ– ====
        initFilters(); // åŠ¨æ€ç”Ÿæˆå¹´çº§å’Œæ¨¡å—çš„ä¸‹æ‹‰é€‰é¡¹

        // ==== ç­›é€‰çŠ¶æ€æ¢å¤é€»è¾‘ ====
        const hasSavedFilters =
          localStorage.getItem('selectedGrades') !== null &&
          localStorage.getItem('selectedModules') !== null;

        if (hasSavedFilters) {
          // éé¦–æ¬¡è¿›å…¥ï¼šåº”ç”¨ä¿å­˜çš„ç­›é€‰æ¡ä»¶
          selectedGrades = JSON.parse(localStorage.getItem('selectedGrades'));
          selectedModules = JSON.parse(localStorage.getItem('selectedModules'));
          applyFilters(); // åº”ç”¨ä¿å­˜çš„ç­›é€‰æ¡ä»¶
        } else {
          // é¦–æ¬¡è¿›å…¥æˆ–é‡ç½®åï¼šæ˜¾ç¤ºç­›é€‰é¢æ¿
          document.getElementById('filterPanel').style.display = 'block';
          document.getElementById('selectedInfo').style.display = 'none';

          // å¼ºåˆ¶é‡ç½®é€‰æ‹©çŠ¶æ€
          selectedGrades = [];
          selectedModules = [];
          updateSelectedLabels(); // æ›´æ–°æ ‡ç­¾æ˜¾ç¤ºä¸º"å…¨é€‰"
        }

        // ==== æ›´æ–°è¿›åº¦å’Œå•è¯ ====
        updateProgress();
        nextWord();

        // ==== è¯­éŸ³å¼•æ“åˆå§‹åŒ– ====
        if ('speechSynthesis' in window) {
          // æ·»åŠ è¯­éŸ³åˆ—è¡¨åŠ è½½ç›‘å¬
          speechSynthesis.onvoiceschanged = () => {
            voices = speechSynthesis.getVoices();
            console.log('è¯­éŸ³åˆ—è¡¨å·²æ›´æ–°:', voices);

            // è‡ªåŠ¨é€‰æ‹©è‹±è¯­è¯­éŸ³
            const enVoice = voices.find(v => v.lang.startsWith('en-'));
            if (enVoice) {
              console.log('å·²æ‰¾åˆ°è‹±è¯­è¯­éŸ³å¼•æ“:', enVoice.name);
            }
          };

          // ç«‹å³è·å–è¯­éŸ³åˆ—è¡¨
          voices = speechSynthesis.getVoices();
        }

        // â–¶ï¸ æ–°å¢ï¼šé¢„åŠ è½½ç¬¬ä¸€ä¸ªå•è¯çš„éŸ³é¢‘ï¼ˆæå‡é¦–æ¬¡ç‚¹å‡»å“åº”é€Ÿåº¦ï¼‰
        if (/MicroMessenger/i.test(navigator.userAgent)) {
          const preloadAudio = new Audio('audio/hello.wav');
          preloadAudio.load();
        }

      } catch (error) {
        // ==== å¼‚å¸¸å¤„ç† ====
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        document.getElementById('current-word').textContent = "æ•°æ®åŠ è½½å¤±è´¥";

        // å¼ºåˆ¶æ˜¾ç¤ºç­›é€‰é¢æ¿
        document.getElementById('filterPanel').style.display = 'block';
        document.getElementById('selectedInfo').style.display = 'none';
      }
    }
    // ==== æ–°å¢ç­›é€‰é€»è¾‘å‡½æ•° ====
    function toggleDropdown(type) {
      const options = document.getElementById(`${type}Options`);
      options.style.display = options.style.display === 'block' ? 'none' : 'block';
    }

    function selectAll(type) {
      const list = type === 'grade' ? GRADE_LIST : MODULE_LIST;
      const current = type === 'grade' ? selectedGrades : selectedModules;
      current.splice(0); // æ¸…ç©ºå½“å‰é€‰æ‹©
      list.forEach(item => current.push(item));
      updateSelectedLabels();
      // ==== æ–°å¢ï¼šå…¨é€‰åå…³é—­ä¸‹æ‹‰èœå• ====
      document.getElementById(`${type}Options`).style.display = 'none';
    }

    function toggleSelect(type, value) {
      const arr = type === 'grade' ? selectedGrades : selectedModules;
      const index = arr.indexOf(value);
      if (index === -1) {
        arr.push(value);
      } else {
        arr.splice(index, 1);
      }
      updateSelectedLabels();

      // ==== æ–°å¢ï¼šé€‰ä¸­åå…³é—­ä¸‹æ‹‰èœå• ====
      document.getElementById(`${type}Options`).style.display = 'none';
    }

    function updateSelectedLabels() {
      // ==== å¹´çº§æ ‡ç­¾æ˜¾ç¤ºé€»è¾‘ä¿®æ”¹ ====
      const gradeLabel = document.getElementById('gradeLabel');
      gradeLabel.textContent = selectedGrades.length === GRADE_LIST.length
        ? 'å…¨é€‰'
        : selectedGrades.length > 3
          ? `å·²é€‰${selectedGrades.length}ä¸ª`
          : selectedGrades.join(', ');

      // ==== å•å…ƒæ ‡ç­¾æ˜¾ç¤ºé€»è¾‘ä¿®æ”¹ ====
      const moduleLabel = document.getElementById('moduleLabel');
      moduleLabel.textContent = selectedModules.length === MODULE_LIST.length
        ? 'å…¨é€‰'
        : selectedModules.length > 3
          ? `å·²é€‰${selectedModules.length}ä¸ª`
          : selectedModules.join(', ');
    }

    function applyFilters() {
      // ==== æ–°å¢ï¼šå¿…é¡»é€‰æ‹©è‡³å°‘ä¸€ä¸ªå¹´çº§å’Œæ¨¡å— ====
      if (selectedGrades.length === 0 || selectedModules.length === 0) {
        alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå¹´çº§å’Œä¸€ä¸ªå•å…ƒï¼");
        return;
      }
      // ==== æ§åˆ¶ç•Œé¢æ˜¾éš ====
      document.getElementById('filterPanel').style.display = 'none';
      document.getElementById('selectedInfo').style.display = 'flex';

      // ==== ä¿å­˜ç­›é€‰çŠ¶æ€ ====
      localStorage.setItem('selectedGrades', JSON.stringify(selectedGrades));
      localStorage.setItem('selectedModules', JSON.stringify(selectedModules));

      // å¤„ç†ç©ºçŠ¶æ€ï¼ˆè§†ä¸ºå…¨é€‰ï¼‰
      const finalGrades = selectedGrades.length > 0 ? selectedGrades : GRADE_LIST;
      const finalModules = selectedModules.length > 0 ? selectedModules : MODULE_LIST;

      // ==== æ•°æ®è¿‡æ»¤ ====
      allWords = flattenData(embeddedWordData).filter(word =>
        finalGrades.includes(word.grade) &&
        finalModules.includes(word.module)
      );

      // ==== åŒæ­¥å·²æŒæ¡å•è¯ ====
      masteredWords = masteredWords.filter(word =>
        allWords.some(w => w.word === word)
      );
      localStorage.setItem('masteredWords', JSON.stringify(masteredWords));

      // ==== æ›´æ–°è¿›åº¦å’Œå•è¯ ====
      updateProgress();
      nextWord();

      // ==== ä¿®æ”¹ç‚¹ï¼šä¼˜åŒ–ç«–æ’å±•ç¤ºé€»è¾‘ ==== ğŸ”µ æ–°å¢ä»£ç å—
      const formatDisplay = (list, fullText) => {
        if (list.length === GRADE_LIST.length || list.length === MODULE_LIST.length) {
          return `<span class="selected-item">${fullText}</span>`; // å…¨é€‰æ—¶å•è¡Œæ˜¾ç¤º
        } else {
          // ç«–æ’å±•ç¤ºæ¯ä¸ªé€‰é¡¹
          return list.map(item => `<span class="selected-item">${item}</span>`).join('');
        }
      };

      // æ›´æ–°å¹´çº§å±•ç¤º
      document.getElementById('selectedGradeList').innerHTML =
        formatDisplay(finalGrades, 'å…¨é€‰'); // ä¿®æ”¹ä¸ºæ“ä½œå®¹å™¨å†…å®¹

      // æ›´æ–°å•å…ƒå±•ç¤º
      document.getElementById('selectedModuleList').innerHTML =
        formatDisplay(finalModules, 'å…¨é€‰'); // ä¿®æ”¹ä¸ºæ“ä½œå®¹å™¨å†…å®¹
    }

    function flattenData(data) {
      return Object.entries(data).flatMap(([grade, modules]) =>
        Object.entries(modules).flatMap(([module, words]) =>
          words.map(word => ({
            ...word,
            grade,
            module
          }))
        )
      );
    }

    function getRandomWord() {
      const availableWords = allWords.filter(word =>
        !masteredWords.includes(word.word)
      );
      return availableWords[Math.floor(Math.random() * availableWords.length)];
    }

    function updateCard(word) {
      currentWord = word;
      document.getElementById('current-word').textContent = word.word;
      document.getElementById('translation').textContent = word.translation;
      document.getElementById('details').innerHTML = `
                <p>å¹´çº§ï¼š${word.grade}ï½œå•å…ƒï¼š${word.module}</p>
                <p style="margin-top:15px;color:#666">${word.example}</p>
            `;
      adjustFontSize();
    }

    function nextWord() {
      const word = getRandomWord();
      if (!word) return alert("æ‰€æœ‰å•è¯å·²å­¦ä¹ å®Œæˆï¼");
      document.querySelector('.flashcard').classList.remove('flipped');
      setTimeout(() => updateCard(word), 300);
    }

    function markAsMastered() {
      if (!currentWord) return;
      const flashcard = document.querySelector('.flashcard');
      const isFront = !flashcard.classList.contains('flipped');

      if (isFront) {
        flashcard.classList.add('flipped');
        setTimeout(() => {
          if (!masteredWords.includes(currentWord.word)) {
            masteredWords.push(currentWord.word);
            localStorage.setItem('masteredWords', JSON.stringify(masteredWords));
            updateProgress();
          }
          nextWord();
        }, 2000);
      } else {
        if (!masteredWords.includes(currentWord.word)) {
          masteredWords.push(currentWord.word);
          localStorage.setItem('masteredWords', JSON.stringify(masteredWords));
          updateProgress();
        }
        nextWord();
      }
    }

    function updateProgress() {
      document.getElementById('progress').textContent =
        `è¿›åº¦ï¼š${masteredWords.length}/${allWords.length}`;
    }

    function showMasteredWords() {
      document.getElementById('masteredPanel').classList.add('active');
      const listContainer = document.getElementById('masteredList');
      listContainer.innerHTML = [...masteredWords].reverse().map(wordStr => { // æ–°å¢reverse()
        const wordData = allWords.find(w => w.word === wordStr);
        return `
                    <div class="mastered-item" onclick="handleMasteredWord('${wordStr}')">
                        <div>${wordStr}</div>
                        <div style="font-size:0.9em;color:#666">${wordData?.translation || 'ç¿»è¯‘æœªæ‰¾åˆ°'}</div>
                        <span class="delete-btn" onclick="removeMasteredWord('${wordStr}')">Ã— åˆ é™¤</span>
                    </div>
                `;
      }).join('');
    }

    function closeMasteredPanel() {
      document.getElementById('masteredPanel').classList.remove('active');
    }

    function removeMasteredWord(word) {
      event.stopPropagation();
      masteredWords = masteredWords.filter(w => w !== word);
      localStorage.setItem('masteredWords', JSON.stringify(masteredWords));
      updateProgress();
      showMasteredWords();
    }

    function handleMasteredWord(word) {
      const items = document.querySelectorAll('.mastered-item');
      items.forEach(item => item.style.background = 'transparent');
      event.currentTarget.style.background = '#f5f5f5';
    }

    function clearAllProgress() {
      if (confirm("ç¡®è®¤è¦é‡ç½®æ‰€æœ‰å­¦ä¹ è¿›åº¦å—ï¼Ÿ")) {
        // ==== æ ¸å¿ƒä¿®æ”¹ï¼šå®Œå…¨é‡ç½®çŠ¶æ€ ====
        // 1. æ¸…ç©ºå·²æŒæ¡å•è¯
        masteredWords = [];
        localStorage.removeItem('masteredWords');

        // 2. é‡ç½®ç­›é€‰çŠ¶æ€ï¼ˆæ”¹ä¸ºç©ºæ•°ç»„ï¼‰
        selectedGrades = [];
        selectedModules = [];
        localStorage.removeItem('selectedGrades');
        localStorage.removeItem('selectedModules');

        // ==== æ–°å¢ï¼šå¼ºåˆ¶æ˜¾ç¤ºç­›é€‰é¢æ¿å¹¶éšè—ä¿¡æ¯ ====
        document.getElementById('filterPanel').style.display = 'block';
        document.getElementById('selectedInfo').style.display = 'none';

        // 3. é‡ç½®æ ‡ç­¾æ˜¾ç¤ºä¸º"å…¨é€‰"
        document.getElementById('gradeLabel').textContent = 'å…¨é€‰';
        document.getElementById('moduleLabel').textContent = 'å…¨é€‰';

        // 4. é‡æ–°åˆå§‹åŒ–æ•°æ®ï¼ˆè€Œä¸æ˜¯è°ƒç”¨applyFiltersï¼‰
        allWords = flattenData(embeddedWordData);
        updateProgress();
        nextWord();
      }
    }
    function adjustFontSize() {
      const elements = [document.getElementById('current-word'), document.getElementById('translation')];
      elements.forEach(el => {
        if (!el) return;
        let fontSize = parseInt(window.getComputedStyle(el).fontSize);
        while (el.scrollHeight > el.offsetHeight && fontSize > 20) {
          fontSize--;
          el.style.fontSize = fontSize + 'px';
        }
      });
    }

    // äº‹ä»¶ç›‘å¬
    document.querySelector('.flashcard').addEventListener('click', (e) => {
      if (
        e.target.closest('button') ||
        e.target.closest('.translation') ||
        e.target.closest('#details') ||
        e.target.closest('.speaker-btn') // æ–°å¢æ’é™¤å–‡å­æŒ‰é’®
      ) return;
      document.querySelector('.flashcard').classList.toggle('flipped');
    });

    // ===== åŸä»£ç ä¸­çš„äº‹ä»¶ç›‘å¬ =====
    document.addEventListener('click', (e) => {
      // åŸæœ‰é€»è¾‘ï¼šå…³é—­å·²æŒæ¡é¢æ¿
      if (!e.target.closest('.mastered-panel') &&
        !e.target.closest('.manage-panel button')) {
        closeMasteredPanel();
      }

      // ==== æ–°å¢é€»è¾‘ï¼šå…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå• ====
      if (!e.target.closest('.custom-select')) { // å¦‚æœç‚¹å‡»ä¸åœ¨ä¸‹æ‹‰ç»„ä»¶å†…
        document.querySelectorAll('.select-options').forEach(el => {
          el.style.display = 'none';
        });
      }
    });

    // æ‰‹åŠ¿æ”¯æŒ
    let touchStartX = 0;
    const flashcard = document.querySelector('.flashcard');
    flashcard.addEventListener('touchstart', e => {
      touchStartX = e.touches[0].clientX;
    });
    flashcard.addEventListener('touchend', e => {
      const touchEndX = e.changedTouches[0].clientX;
      const diffX = touchEndX - touchStartX;
      if (Math.abs(diffX) > 50) {
        flashcard.classList.toggle('flipped');
      }
    });

    // ç”¨æˆ·é¦–æ¬¡ç‚¹å‡»é¡µé¢æ—¶éšè—æç¤º
    document.addEventListener('click', () => {
      document.getElementById('voiceHint').style.display = 'none';
    }, { once: true });

    // åˆå§‹åŒ–æ—¶æ˜¾ç¤ºæç¤ºï¼ˆä»…ç§»åŠ¨ç«¯ï¼‰
    if (/Mobi|Android/i.test(navigator.userAgent)) {
      document.getElementById('voiceHint').style.display = 'block';
    }

    window.addEventListener('resize', adjustFontSize);
    window.addEventListener('load', initializeData);
  </script>
</body>

</html>